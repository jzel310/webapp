name: Build webapp

on: [push]

jobs:
  build_and_push:
    name: Push webapp image to docker hub
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v3
      
      - name: Auth to ACR
        uses: azure/docker-login@v1
        with:
          login-server: acmellc.azurecr.io
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
      
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: webapp
      
      - name: Build and Publish
        uses: docker/build-push-action@v2
        with:
          context: .
          file: Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
  # deploy:
  #   needs: push_to_registry
  #   name: Deploy to Kubernetes
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v2
  #   - name: Create kubeconfig
  #     run: |
  #       mkdir ${HOME}/.kube
  #       echo ${{ secrets.KUBE_CONFIG }} | base64 --decode > ${HOME}/.kube/config
  #       cat ${HOME}/.kube/config
  #   - name: Use context
  #     run: kubectl config use-context do-sfo3-focuscluster-cluster
  #   - name: Deploy to K8s
  #     run: helm upgrade -f helm/ssr/test-ssr/values.yaml focussr helm/ssr/test-ssr/  